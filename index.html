<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <title>ä¸ªäººç§¯åˆ†è®°å½•ç³»ç»Ÿ</title>

    <!-- ===== CSSï¼šå®Œå…¨ä¿ç•™ä½ åŸæ¥çš„æ ·å¼ ===== -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:'Arial',sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;
            padding:10px;
            font-size:16px;
            -webkit-text-size-adjust:100%;
        }
        .container{
            max-width:100%;
            margin:0 auto;
            background:rgba(255,255,255,.95);
            border-radius:20px;
            box-shadow:0 20px 40px rgba(0,0,0,.1);
            overflow:hidden;
        }
        .header{
            background:linear-gradient(135deg,#ff6b6b,#ffd93d);
            padding:20px;
            text-align:center;
            color:#fff;
        }
        .header h1{
            font-size:2em;
            margin-bottom:10px;
            text-shadow:2px 2px 4px rgba(0,0,0,.3);
        }
        .total-score{
            font-size:1.3em;
            font-weight:bold;
            background:rgba(255,255,255,.2);
            padding:15px;
            border-radius:15px;
            margin-top:15px;
        }
        .content{padding:20px;}
        .section{
            margin-bottom:25px;
            background:rgba(102,126,234,.05);
            padding:20px;
            border-radius:15px;
            border-left:5px solid #667eea;
        }
        .section h2{color:#667eea;margin-bottom:15px;font-size:1.2em;}
        .input-group{display:flex;flex-direction:column;margin-bottom:15px;gap:8px;}
        .input-group.row{flex-direction:row;align-items:center;gap:15px;}
        .input-group label{font-weight:bold;color:#333;font-size:1em;}
        input[type=checkbox]{width:24px;height:24px;cursor:pointer;transform:scale(1.2);}
        input[type=number],input[type=text],input[type=date],select{
            padding:15px;border:2px solid #ddd;border-radius:10px;font-size:16px;
            transition:border-color .3s;width:100%;-webkit-appearance:none;appearance:none;
        }
        input[type=number]:focus,
        input[type=text]:focus,
        input[type=date]:focus,
        select:focus{
            outline:none;border-color:#667eea;box-shadow:0 0 10px rgba(102,126,234,.2);
        }
        .btn{
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:#fff;border:none;padding:15px 20px;border-radius:25px;cursor:pointer;
            font-size:16px;font-weight:bold;margin:8px 0;transition:all .3s;
            box-shadow:0 5px 15px rgba(102,126,234,.3);width:100%;touch-action:manipulation;
        }
        .btn:hover,.btn:active{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,.4);}
        .btn-small{padding:8px 12px;font-size:14px;margin:2px;width:auto;min-width:60px;}
        .btn-danger{background:linear-gradient(135deg,#ff6b6b,#ee5a52);}
        .btn-export{background:linear-gradient(135deg,#28a745,#20c997);}
        .btn-edit{background:linear-gradient(135deg,#ffc107,#ff8c00);}
        .button-group{display:grid;grid-template-columns:1fr;gap:10px;margin:20px 0;}
        @media (min-width:480px){.button-group{grid-template-columns:1fr 1fr;}}
        .reward-section{background:linear-gradient(135deg,rgba(255,193,61,.1),rgba(255,107,107,.1));border-left-color:#ffc13d;}
        .history{margin-top:25px;}
        .history-item{
            background:#fff;padding:15px;margin-bottom:12px;border-radius:10px;
            border-left:4px solid #667eea;box-shadow:0 2px 10px rgba(0,0,0,.05);position:relative;
        }
        .history-item .header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px;}
        .history-item .date{color:#666;font-size:.9em;}
        .history-item .score{font-weight:bold;color:#667eea;font-size:1.1em;min-width:80px;text-align:right;}
        .history-item .action-buttons{display:flex;gap:5px;margin-top:10px;justify-content:flex-end;}
        .score-negative{color:#ff6b6b!important;}
        .progress-bar{background:#f0f0f0;border-radius:10px;height:20px;margin:10px 0;overflow:hidden;}
        .progress-fill{background:linear-gradient(90deg,#667eea,#764ba2);height:100%;border-radius:10px;transition:width .5s ease;}
        .reward-info{background:rgba(255,193,61,.1);padding:15px;border-radius:10px;margin-top:15px;border:2px dashed #ffc13d;font-size:.95em;}
        .checkbox-group{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.5);padding:15px;border-radius:10px;margin-top:10px;}
        .score-indicator{color:#667eea;font-weight:bold;font-size:.9em;}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);animation:fadeIn .3s;}
        .modal-content{
            background:#fff;margin:5% auto;padding:20px;border-radius:15px;width:90%;max-width:500px;
            max-height:80vh;overflow-y:auto;position:relative;animation:slideIn .3s;
        }
        .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;position:absolute;right:15px;top:10px;}
        .close:hover{color:#000;}
        @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
        @keyframes slideIn{from{transform:translateY(-50px);opacity:0;}to{transform:translateY(0);opacity:1;}}
        .storage-status{
            position:fixed;bottom:20px;right:20px;background:rgba(0,0,0,.8);color:#fff;
            padding:8px 12px;border-radius:20px;font-size:12px;z-index:100;
        }
        .storage-status.success{background:rgba(40,167,69,.9);}
        .storage-status.error{background:rgba(220,53,69,.9);}
        .touchable{touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
        input,select,textarea{font-size:16px!important;}
        .loading{display:none;text-align:center;padding:20px;color:#667eea;}
        .date-selector{background:rgba(102,126,234,.05);padding:15px;border-radius:10px;margin-bottom:20px;border-left:4px solid #667eea;}
    </style>
</head>

<body>
    <!-- ===== ä¸»è¦ç»“æ„ï¼šåŒä½ åŸæ–‡ ===== -->
    <div class="container">
        <div class="header">
            <h1>ğŸ† ç§¯åˆ†è®°å½•ç³»ç»Ÿ</h1>
            <div class="total-score">
                æ€»ç§¯åˆ†: <span id="totalScore">0</span> åˆ†
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div style="font-size:.85em;margin-top:8px;">è·ç¦»ä¸‹æ¬¡å¥–åŠ±è¿˜éœ€: <span id="pointsNeeded">15</span> åˆ†</div>
            </div>
        </div>

        <div class="content">
            <!-- æ—¥æœŸé€‰æ‹© -->
            <div class="section date-selector">
                <h2>ğŸ“… è®°å½•æ—¥æœŸ</h2>
                <div class="input-group">
                    <label for="recordDate">é€‰æ‹©æ—¥æœŸ:</label>
                    <input type="date" id="recordDate" onchange="loadDateData()" />
                    <div style="font-size:.9em;color:#666;margin-top:5px;">å½“å‰é€‰æ‹©: <span id="selectedDateDisplay">ä»Šå¤©</span></div>
                </div>
            </div>

            <!-- æ—©èµ·è®°å½• -->
            <div class="section">
                <h2>ğŸŒ… æ—©èµ·è®°å½• (7ç‚¹èµ·åºŠ)</h2>
                <div class="checkbox-group touchable">
                    <input type="checkbox" id="earlyRise" onchange="updateScore()" />
                    <label for="earlyRise">æ—©èµ·äº†å—ï¼Ÿ</label>
                    <span class="score-indicator">+1åˆ†</span>
                </div>
            </div>

            <!-- ä¸“æ³¨æ—¶é•¿ -->
            <div class="section">
                <h2>ğŸ… ä¸“æ³¨æ—¶é•¿ (ç•ªèŒ„é’Ÿ)</h2>
                <div class="input-group">
                    <label for="focusHours">ä¸“æ³¨æ—¶é•¿ (å°æ—¶):</label>
                    <input type="number" id="focusHours" min="0" max="24" step="0.5" onchange="updateScore()" placeholder="è¾“å…¥ä¸“æ³¨å°æ—¶æ•°" />
                    <div class="score-indicator">æ¯å°æ—¶ +0.5åˆ†</div>
                </div>
            </div>

            <!-- ä»»åŠ¡å®Œæˆåº¦ -->
            <div class="section">
                <h2>âœ… ä»»åŠ¡å®Œæˆåº¦</h2>
                <div class="input-group">
                    <label for="taskCompletion">å®Œæˆåº¦ (%):</label>
                    <input type="number" id="taskCompletion" min="0" max="100" onchange="updateScore()" placeholder="è¾“å…¥å®Œæˆç™¾åˆ†æ¯”" />
                    <div class="score-indicator">60-80%: +1åˆ† | 80-100%: +2åˆ†</div>
                </div>
            </div>

            <!-- å½“æ—¥å¾—åˆ† -->
            <div class="section" style="background:rgba(40,167,69,.05);border-left-color:#28a745;">
                <h2>ğŸ“Š å½“æ—¥å¾—åˆ†</h2>
                <div style="font-size:1.2em;font-weight:bold;color:#28a745;text-align:center;padding:10px;">
                    <span id="todayScore">0</span> åˆ†
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="button-group">
                <button class="btn touchable" id="saveBtn" onclick="saveRecord()">ğŸ“ ä¿å­˜è®°å½•</button>
                <button class="btn btn-danger touchable" onclick="clearToday()">ğŸ”„ é‡ç½®å½“å‰</button>
                <button class="btn btn-export touchable" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-danger touchable" onclick="resetAllData()">âš ï¸ é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>

            <!-- å¥–åŠ±å…‘æ¢ -->
            <div class="section reward-section">
                <h2>ğŸ å¥–åŠ±å…‘æ¢</h2>
                <div class="reward-info">
                    <strong>å…‘æ¢è§„åˆ™:</strong><br>
                    â€¢ 15åˆ† = èŠ’æœæ¯›å·¾å· / é›ªåªšå¨˜<br>
                    â€¢ 30åˆ† = 4å¯¸å°è›‹ç³• / 20å…ƒå†…ä»»é€‰ç¤¼ç‰©<br>
                    â€¢ 45åˆ† = 35å…ƒå†…ä»»é€‰ç¤¼ç‰©<br>
                    â€¢ 60åˆ† = 50å…ƒå†…ä»»é€‰ç¤¼ç‰©<br>
                    <strong>å½“å‰å¯å…‘æ¢:</strong> <span id="availableRewards">æš‚æ— </span>
                </div>

                <div class="input-group">
                    <label for="rewardType">é€‰æ‹©å¥–åŠ±:</label>
                    <select id="rewardType" onchange="updateRewardUI()">
                        <option value="">è¯·é€‰æ‹©å¥–åŠ±ç±»å‹</option>
                        <option value="15">15åˆ† - èŠ’æœæ¯›å·¾å· / é›ªåªšå¨˜</option>
                        <option value="30">30åˆ† - 4å¯¸å°è›‹ç³• / 20å…ƒå†…ä»»é€‰</option>
                        <option value="45">45åˆ† - 35å…ƒå†…ä»»é€‰ç¤¼ç‰©</option>
                        <option value="60">60åˆ† - 50å…ƒå†…ä»»é€‰ç¤¼ç‰©</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="rewardName">å…·ä½“å¥–å“:</label>
                    <input type="text" id="rewardName" placeholder="è¾“å…¥å…·ä½“å¥–å“åç§°" />
                </div>

                <button class="btn touchable" style="background:linear-gradient(135deg,#ffc13d,#ff6b6b);" onclick="redeemReward()">ğŸ¯ å…‘æ¢å¥–åŠ±</button>
            </div>

            <!-- å†å²è®°å½• -->
            <div class="history">
                <h2 style="color:#667eea;margin-bottom:15px;">ğŸ“Š å†å²è®°å½•</h2>
                <div class="loading" id="loadingHistory">åŠ è½½ä¸­...</div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 style="color:#667eea;margin-bottom:20px;">âœï¸ ç¼–è¾‘è®°å½•</h2>

            <div class="input-group">
                <label for="editDate">æ—¥æœŸ:</label>
                <input type="date" id="editDate" />
            </div>
            <div class="input-group">
                <label for="editEarlyRise">æ—©èµ·:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="editEarlyRise" onchange="updateEditScore()" />
                    <label for="editEarlyRise">æ—©èµ·äº†</label>
                    <span class="score-indicator">+1åˆ†</span>
                </div>
            </div>
            <div class="input-group">
                <label for="editFocusHours">ä¸“æ³¨æ—¶é•¿ (å°æ—¶):</label>
                <input type="number" id="editFocusHours" min="0" max="24" step="0.5" onchange="updateEditScore()" />
            </div>
            <div class="input-group">
                <label for="editTaskCompletion">ä»»åŠ¡å®Œæˆåº¦ (%):</label>
                <input type="number" id="editTaskCompletion" min="0" max="100" onchange="updateEditScore()" />
            </div>

            <div class="input-group">
                è®¡ç®—å¾—åˆ†: <span id="editCalculatedScore" style="color:#28a745;font-weight:bold;">0</span> åˆ†
            </div>
            <div class="input-group">
                <label for="editScore">æœ€ç»ˆå¾—åˆ†:</label>
                <input type="number" id="editScore" step="0.1" placeholder="å¯æ‰‹åŠ¨è°ƒæ•´åˆ†æ•°" />
            </div>

            <div class="button-group">
                <button class="btn touchable" onclick="saveEditRecord()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button class="btn btn-danger touchable" onclick="closeEditModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å­˜å‚¨æŒ‡ç¤º -->
    <div id="storageStatus" class="storage-status" style="display:none;"></div>

    <!-- ===== JavaScriptï¼šæ•´åˆå¹¶è¡¥å®Œ ===== -->
    <script>
        /**********************  å…¨å±€å˜é‡  **********************/
        let totalScore       = 0;                    // æ€»ç§¯åˆ†
        let todayScore       = 0;                    // å½“æ—¥ç§¯åˆ†
        let history          = [];                   // å†å²è®°å½•æ•°ç»„
        let currentEditIndex = -1;                   // å½“å‰ç¼–è¾‘çš„ç´¢å¼•
        let selectedDate     = new Date().toLocaleDateString('zh-CN'); // æ—¥æœŸé€‰æ‹©å™¨çš„æ—¥æœŸ

        /**********************  åˆå§‹åŒ–  **********************/
        window.onload = () => {
            const today = new Date();
            document.getElementById('recordDate').value = today.toISOString().split('T')[0];
            selectedDate = today.toLocaleDateString('zh-CN');

            loadData();
            loadDateData();
            updateDisplay();
            addTouchFeedback();
            checkStorageSupport();
        };

        /**********************  å·¥å…·å‡½æ•°  **********************/
        function toast(msg){ alert(msg); }

        function checkStorageSupport(){
            try{
                const key='storageTest';
                localStorage.setItem(key,'test');
                localStorage.removeItem(key);
                showStorageStatus('å­˜å‚¨æ”¯æŒæ­£å¸¸','success');
            }catch(e){
                console.warn('localStorage ä¸å¯ç”¨');
                showStorageStatus('å­˜å‚¨åŠŸèƒ½å—é™','error');
            }
        }
        function showStorageStatus(msg,type){
            const el=document.getElementById('storageStatus');
            el.textContent = msg;
            el.className   = 'storage-status '+type;
            el.style.display='block';
            setTimeout(()=>el.style.display='none',3000);
        }
        function addTouchFeedback(){
            document.querySelectorAll('.touchable').forEach(el=>{
                el.addEventListener('touchstart',()=>el.style.opacity='0.7');
                el.addEventListener('touchend'  ,()=>el.style.opacity='1');
            });
        }

        /**********************  æœ¬åœ°å­˜å‚¨  **********************/
        function saveData(){
            const data={totalScore,history,lastSaveDate:new Date().toDateString(),version:'2.0'};
            try{
                localStorage.setItem('scoreTrackerData',JSON.stringify(data));
                showStorageStatus('æ•°æ®å·²ä¿å­˜','success');
            }catch(e){
                console.warn('localStorage save å¤±è´¥ï¼Œæ”¹ç”¨ sessionStorage');
                try{
                    sessionStorage.setItem('scoreTrackerBackup',JSON.stringify(data));
                    showStorageStatus('å·²ä¿å­˜åˆ°ä¸´æ—¶å­˜å‚¨','success');
                }catch(_){
                    toast('âš ï¸ æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·ç«‹å³å¯¼å‡ºå¤‡ä»½ï¼');
                    showStorageStatus('ä¿å­˜å¤±è´¥','error');
                }
            }
        }
        function loadData(){
            let raw = localStorage.getItem('scoreTrackerData') || sessionStorage.getItem('scoreTrackerBackup');
            if(raw){
                try{
                    const data=JSON.parse(raw);
                    totalScore = data.totalScore || 0;
                    history    = data.history    || [];
                }catch(_){}
            }
            updateHistoryDisplay();
        }

        /**********************  æ—¥æœŸç›¸å…³  **********************/
        function loadDateData(){
            const sel = document.getElementById('recordDate');
            selectedDate = new Date(sel.value).toLocaleDateString('zh-CN');
            document.getElementById('selectedDateDisplay').textContent =
                selectedDate === new Date().toLocaleDateString('zh-CN') ? 'ä»Šå¤©' : selectedDate;

            const existing = history.find(r=>r.date===selectedDate && r.score>0);
            if(existing){
                loadRecordToForm(existing);
                document.getElementById('saveBtn').textContent='ğŸ“ æ›´æ–°è®°å½•';
            }else{
                clearToday();
                document.getElementById('saveBtn').textContent='ğŸ“ ä¿å­˜è®°å½•';
            }
        }
        function loadRecordToForm(rec){
            clearToday();
            if(rec.details.includes('æ—©èµ·')) document.getElementById('earlyRise').checked=true;
            const focus = rec.details.match(/ä¸“æ³¨([\\d.]+)å°æ—¶/);
            if(focus) document.getElementById('focusHours').value=focus[1];
            const task  = rec.details.match(/ä»»åŠ¡å®Œæˆ(\\d+)%/);
            if(task) document.getElementById('taskCompletion').value=task[1];
            updateScore();
        }

        /**********************  è®¡åˆ†é€»è¾‘  **********************/
        function updateScore(){
            todayScore = 0;
            if(document.getElementById('earlyRise').checked) todayScore += 1;
            const focus = parseFloat(document.getElementById('focusHours').value) || 0;
            todayScore += focus * 0.5;
            const completion = parseInt(document.getElementById('taskCompletion').value) || 0;
            if(completion>=60 && completion<80) todayScore += 1;
            else if(completion>=80)             todayScore += 2;
            updateDisplay();
        }
        function updateEditScore(){
            let s=0;
            if(document.getElementById('editEarlyRise').checked) s+=1;
            const fh=parseFloat(document.getElementById('editFocusHours').value)||0;
            s+=fh*0.5;
            const tc=parseInt(document.getElementById('editTaskCompletion').value)||0;
            if(tc>=60 && tc<80) s+=1;
            else if(tc>=80)     s+=2;
            document.getElementById('editCalculatedScore').textContent=s.toFixed(1);
            document.getElementById('editScore').value=s.toFixed(1);
        }
        function updateDisplay(){
            document.getElementById('totalScore').textContent = totalScore.toFixed(1);
            document.getElementById('todayScore').textContent = todayScore.toFixed(1);

            const rewards=[];
            if(totalScore>=60) rewards.push('60åˆ†å¥–åŠ±');
            else if(totalScore>=45) rewards.push('45åˆ†å¥–åŠ±');
            else if(totalScore>=30) rewards.push('30åˆ†å¥–åŠ±');
            else if(totalScore>=15) rewards.push('15åˆ†å¥–åŠ±');
            document.getElementById('availableRewards').textContent = rewards.length?rewards.join(', '):'æš‚æ— å¯å…‘æ¢å¥–åŠ±';

            let next=15;
            if(totalScore>=15) next=30;
            if(totalScore>=30) next=45;
            if(totalScore>=45) next=60;
            if(totalScore>=60) next=Math.ceil((totalScore+1)/15)*15;
            document.getElementById('pointsNeeded').textContent = Math.max(0,next-totalScore).toFixed(1);

            const progress = totalScore>=15?((totalScore%15)/15*100):(totalScore/15*100);
            document.getElementById('progressFill').style.width = progress+'%';
        }

        /**********************  ä¿å­˜è®°å½•  **********************/
        function saveRecord(){
            if(todayScore<=0){ toast('è¯·å…ˆå¡«å†™ä»Šæ—¥çš„å®Œæˆæƒ…å†µï¼'); return; }

            /* ç”Ÿæˆè¯¦æƒ… */
            const details=[];
            if(document.getElementById('earlyRise').checked) details.push('æ—©èµ·');
            const f=parseFloat(document.getElementById('focusHours').value)||0;
            if(f>0) details.push(`ä¸“æ³¨${f}å°æ—¶`);
            const t=parseInt(document.getElementById('taskCompletion').value)||0;
            if(t>0) details.push(`ä»»åŠ¡å®Œæˆ${t}%`);
            const record={
                date:selectedDate,
                score:parseFloat(todayScore.toFixed(1)),
                details:details.join('ã€')
            };

            const idx=history.findIndex(r=>r.date===selectedDate && r.score>0);
            if(idx!==-1){
                totalScore-=history[idx].score;
                history[idx]=record;
            }else{
                history.push(record);
            }
            totalScore+=record.score;

            saveData();
            updateDisplay();
            updateHistoryDisplay();
            clearToday();
            document.getElementById('saveBtn').textContent='ğŸ“ ä¿å­˜è®°å½•';
            toast('âœ”ï¸ å·²ä¿å­˜');
        }

        /**********************  æ•°æ®å¯¼å‡º  **********************/
        function exportData(){
            const dataStr=JSON.stringify({totalScore,history,exportDate:new Date().toLocaleString('zh-CN'),version:'2.0'},null,2);
            const ta=document.createElement('textarea');
            ta.value=dataStr; ta.style.position='fixed'; ta.style.opacity='0';
            document.body.appendChild(ta); ta.select();
            try{
                document.execCommand('copy');
                toast('âœ… æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }catch(_){
                prompt('è¯·å¤åˆ¶ä»¥ä¸‹æ•°æ®è¿›è¡Œå¤‡ä»½ï¼š',dataStr);
            }
            document.body.removeChild(ta);
        }

        /**********************  æ¸…ç©º / é‡ç½®  **********************/
        function clearToday(){
            document.getElementById('earlyRise').checked=false;
            document.getElementById('focusHours').value='';
            document.getElementById('taskCompletion').value='';
            todayScore=0; updateDisplay();
        }
        function resetAllData(){
            if(!confirm('âš ï¸ ç¡®è®¤é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            totalScore=0; history=[]; todayScore=0;
            selectedDate=new Date().toLocaleDateString('zh-CN');
            saveData(); updateDisplay(); updateHistoryDisplay(); clearToday();
            toast('æ•°æ®å·²å…¨éƒ¨é‡ç½®');
        }

        /**********************  å¥–åŠ±å…‘æ¢  **********************/
        function updateRewardUI(){
            const sel=document.getElementById('rewardType');
            const ip=document.getElementById('rewardName');
            ip.placeholder = sel.value ? sel.options[sel.selectedIndex].text.split('-')[1].trim() : 'è¾“å…¥å…·ä½“å¥–å“åç§°';
        }
        function redeemReward(){
            const cost=parseInt(document.getElementById('rewardType').value||'0');
            const name=document.getElementById('rewardName').value.trim();
            if(!cost){ toast('è¯·é€‰æ‹©å¥–åŠ±ç±»å‹'); return; }
            if(totalScore<cost){ toast('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢'); return; }
            const display=name||'å¥–åŠ±';
            if(!confirm(`ç¡®è®¤å…‘æ¢ã€Œ${display}ã€ï¼Ÿå°†æ‰£é™¤ ${cost} åˆ†ã€‚`)) return;

            totalScore-=cost;
            history.push({date:new Date().toLocaleDateString('zh-CN'),score:-cost,details:`å…‘æ¢å¥–åŠ±: ${display}`});
            saveData(); updateDisplay(); updateHistoryDisplay();
            document.getElementById('rewardType').value=''; document.getElementById('rewardName').value='';
            toast('ğŸ‰ å…‘æ¢æˆåŠŸï¼');
        }

        /**********************  å†å²è®°å½•æ¸²æŸ“  **********************/
        function updateHistoryDisplay(){
            const list=document.getElementById('historyList');
            list.innerHTML='';
            const sorted=[...history].sort((a,b)=>new Date(b.date)-new Date(a.date));
            sorted.forEach(rec=>{
                const idx=history.indexOf(rec);
                const item=document.createElement('div'); item.className='history-item';

                const header=document.createElement('div'); header.className='header-row';
                const d=document.createElement('span'); d.className='date'; d.textContent=rec.date;
                const s=document.createElement('span'); s.className='score';
                s.textContent=(rec.score>=0?'+':'')+rec.score.toFixed(1);
                if(rec.score<0) s.classList.add('score-negative');
                header.appendChild(d); header.appendChild(s);

                const det=document.createElement('p'); det.textContent=rec.details;

                const btns=document.createElement('div'); btns.className='action-buttons';
                const eb=document.createElement('button'); eb.className='btn btn-small btn-edit touchable'; eb.textContent='ç¼–è¾‘';
                eb.onclick=()=>openEditModal(idx);
                const db=document.createElement('button'); db.className='btn btn-small btn-danger touchable'; db.textContent='åˆ é™¤';
                db.onclick=()=>deleteRecord(idx);
                btns.appendChild(eb); btns.appendChild(db);

                item.appendChild(header); item.appendChild(det); item.appendChild(btns);
                list.appendChild(item);
            });
        }
        function deleteRecord(idx){
            if(!confirm('åˆ é™¤è¯¥è®°å½•ï¼Ÿ')) return;
            totalScore-=history[idx].score; history.splice(idx,1);
            saveData(); updateDisplay(); updateHistoryDisplay();
        }

        /**********************  ç¼–è¾‘æ¨¡æ€æ¡†  **********************/
        function openEditModal(idx){
            currentEditIndex=idx;
            const rec=history[idx];
            document.getElementById('editDate').value=new Date(rec.date).toISOString().split('T')[0];
            document.getElementById('editEarlyRise').checked=rec.details.includes('æ—©èµ·');
            const f=rec.details.match(/ä¸“æ³¨([\\d.]+)å°æ—¶/);
            document.getElementById('editFocusHours').value=f?f[1]:'';
            const t=rec.details.match(/ä»»åŠ¡å®Œæˆ(\\d+)%/);
            document.getElementById('editTaskCompletion').value=t?t[1]:'';
            document.getElementById('editScore').value=rec.score.toFixed(1);
            document.getElementById('editCalculatedScore').textContent=rec.score.toFixed(1);
            document.getElementById('editModal').style.display='block';
        }
        function closeEditModal(){ document.getElementById('editModal').style.display='none'; currentEditIndex=-1; }
        function saveEditRecord(){
            if(currentEditIndex===-1) return;
            const newDate=new Date(document.getElementById('editDate').value).toLocaleDateString('zh-CN');
            const newScore=parseFloat(document.getElementById('editScore').value||'0');
            const details=[];
            if(document.getElementById('editEarlyRise').checked) details.push('æ—©èµ·');
            const fh=parseFloat(document.getElementById('editFocusHours').value)||0;
            if(fh>0) details.push(`ä¸“æ³¨${fh}å°æ—¶`);
            const tc=parseInt(document.getElementById('editTaskCompletion').value)||0;
            if(tc>0) details.push(`ä»»åŠ¡å®Œæˆ${tc}%`);

            totalScore-=history[currentEditIndex].score;
            history[currentEditIndex]={date:newDate,score:newScore,details:details.join('ã€')};
            totalScore+=newScore;

            saveData(); updateDisplay(); updateHistoryDisplay(); closeEditModal(); toast('å·²æ›´æ–°');
        }
    </script>
</body>
</html>
